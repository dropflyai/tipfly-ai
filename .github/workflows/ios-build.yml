name: iOS Build & Submit to TestFlight

on:
  # Auto-trigger on push to main
  push:
    branches:
      - main
    paths:
      - 'src/**'
      - 'assets/**'
      - 'app.json'
      - 'package.json'

  # Manual trigger
  workflow_dispatch:
    inputs:
      submit_to_testflight:
        description: 'Submit to TestFlight'
        required: true
        default: true
        type: boolean

env:
  BUNDLE_ID: com.tipflyai.app
  APP_NAME: tipflyaiapp

jobs:
  build-ios:
    name: Build iOS App
    runs-on: macos-14
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Setup Ruby (for CocoaPods)
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true

      - name: Install CocoaPods
        run: sudo gem install cocoapods

      - name: Setup Expo CLI
        run: npm install -g expo-cli eas-cli

      - name: Create credentials directory
        run: mkdir -p ~/credentials

      - name: Decode signing certificate
        run: |
          printf '%s' "${{ secrets.IOS_DIST_CERT_BASE64 }}" | base64 --decode > ~/credentials/distribution.p12
          echo "Certificate file size: $(wc -c < ~/credentials/distribution.p12) bytes"

      - name: Decode provisioning profile
        run: |
          printf '%s' "${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}" | base64 --decode > ~/credentials/profile.mobileprovision

      - name: Install signing certificate to keychain
        run: |
          # Create temporary keychain
          KEYCHAIN_PATH="$RUNNER_TEMP/app-signing.keychain-db"
          KEYCHAIN_PASSWORD="$(openssl rand -base64 32)"

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # Import certificate
          security import ~/credentials/distribution.p12 \
            -P "${{ secrets.IOS_DIST_CERT_PASSWORD }}" \
            -A -t cert -f pkcs12 \
            -k "$KEYCHAIN_PATH"

          security list-keychain -d user -s "$KEYCHAIN_PATH"

          # Allow codesign access
          security set-key-partition-list -S apple-tool:,apple:,codesign: \
            -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # Save keychain path for cleanup
          echo "KEYCHAIN_PATH=$KEYCHAIN_PATH" >> $GITHUB_ENV

      - name: Install provisioning profile
        run: |
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          PROFILE_UUID=$(security cms -D -i ~/credentials/profile.mobileprovision | plutil -extract UUID raw -)
          cp ~/credentials/profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/$PROFILE_UUID.mobileprovision
          echo "PROFILE_UUID=$PROFILE_UUID" >> $GITHUB_ENV

      - name: Generate native iOS project
        run: npx expo prebuild --platform ios --clean
        env:
          EXPO_PUBLIC_SUPABASE_URL: ${{ secrets.EXPO_PUBLIC_SUPABASE_URL }}
          EXPO_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.EXPO_PUBLIC_SUPABASE_ANON_KEY }}
          EXPO_PUBLIC_ANTHROPIC_API_KEY: ${{ secrets.EXPO_PUBLIC_ANTHROPIC_API_KEY }}

      - name: Install CocoaPods dependencies
        run: |
          cd ios
          pod install

      - name: Build archive
        run: |
          cd ios
          xcodebuild -workspace ${{ env.APP_NAME }}.xcworkspace \
            -scheme ${{ env.APP_NAME }} \
            -configuration Release \
            -archivePath $RUNNER_TEMP/${{ env.APP_NAME }}.xcarchive \
            -destination 'generic/platform=iOS' \
            -allowProvisioningUpdates \
            archive \
            CODE_SIGN_STYLE=Manual \
            CODE_SIGN_IDENTITY="iPhone Distribution" \
            PROVISIONING_PROFILE_SPECIFIER="${{ secrets.IOS_PROVISIONING_PROFILE_NAME }}" \
            DEVELOPMENT_TEAM="${{ secrets.APPLE_TEAM_ID }}"

      - name: Create ExportOptions.plist
        run: |
          cat > $RUNNER_TEMP/ExportOptions.plist << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>method</key>
              <string>app-store</string>
              <key>teamID</key>
              <string>${{ secrets.APPLE_TEAM_ID }}</string>
              <key>uploadSymbols</key>
              <true/>
              <key>signingStyle</key>
              <string>manual</string>
              <key>provisioningProfiles</key>
              <dict>
                  <key>${{ env.BUNDLE_ID }}</key>
                  <string>${{ secrets.IOS_PROVISIONING_PROFILE_NAME }}</string>
              </dict>
          </dict>
          </plist>
          EOF

      - name: Export IPA
        run: |
          xcodebuild -exportArchive \
            -archivePath $RUNNER_TEMP/${{ env.APP_NAME }}.xcarchive \
            -exportPath $RUNNER_TEMP/build \
            -exportOptionsPlist $RUNNER_TEMP/ExportOptions.plist

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: TipFly-iOS-${{ github.sha }}
          path: ${{ runner.temp }}/build/*.ipa
          retention-days: 30

      - name: Setup App Store Connect API Key
        if: github.event_name == 'push' || inputs.submit_to_testflight == true
        run: |
          mkdir -p ~/private_keys
          echo "${{ secrets.APP_STORE_CONNECT_API_KEY }}" > ~/private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}.p8

      - name: Upload to TestFlight
        if: github.event_name == 'push' || inputs.submit_to_testflight == true
        run: |
          xcrun altool --upload-app \
            --type ios \
            --file "$RUNNER_TEMP/build/${{ env.APP_NAME }}.ipa" \
            --apiKey "${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}" \
            --apiIssuer "${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}"
        env:
          API_PRIVATE_KEY_PATH: ~/private_keys

      - name: Cleanup keychain
        if: always()
        run: |
          if [ -n "$KEYCHAIN_PATH" ]; then
            security delete-keychain "$KEYCHAIN_PATH" || true
          fi
          rm -rf ~/credentials ~/private_keys || true
